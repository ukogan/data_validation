<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODCV Timeline - Sliding Window View</title>
    <style>
        :root {
            --occupied-color: #4CAF50;
            --unoccupied-color: #f44336;
            --active-color: #2196F3;
            --standby-color: #FF9800;
            --violation-color: #9C27B0;
            --missing-data: #e0e0e0;
            --grid-line: #ddd;
            --window-color: rgba(33, 150, 243, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        .header {
            background: white;
            padding: 15px 20px;
            border-bottom: 2px solid #e0e0e0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 20px;
            color: #333;
        }

        .month-navigator {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            z-index: 90;
        }

        .month-overview-bar {
            position: relative;
            height: 60px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(30, 1fr);
            height: 100%;
            position: relative;
        }

        .day-column {
            border-right: 1px solid #e0e0e0;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .day-column:hover {
            background: rgba(0,0,0,0.05);
        }

        .day-label {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            color: #666;
        }

        .day-activity {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top,
                var(--occupied-color) 0%,
                var(--occupied-color) 40%,
                var(--active-color) 40%,
                var(--active-color) 100%);
            opacity: 0.6;
        }

        .violation-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--violation-color);
        }

        .viewing-window {
            position: absolute;
            top: 0;
            bottom: 0;
            background: var(--window-color);
            border: 2px solid var(--active-color);
            cursor: grab;
            transition: none;
            z-index: 10;
        }

        .viewing-window:active {
            cursor: grabbing;
        }

        .window-info {
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 11px;
            background: var(--active-color);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .main-viewer {
            position: fixed;
            top: 180px;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            overflow-y: auto;
            padding: 20px;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .current-range {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .viewer-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #f0f0f0;
        }

        .btn-primary {
            background: var(--active-color);
            color: white;
            border-color: var(--active-color);
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .zone-container {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .zone-header {
            background: #f8f8f8;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }

        .signal-response-viewer {
            padding: 15px;
            background: white;
        }

        .timeline-row {
            position: relative;
            height: 40px;
            margin-bottom: 5px;
            background: #fafafa;
            border-radius: 4px;
            overflow: hidden;
        }

        .row-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: #666;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            z-index: 5;
        }

        .data-canvas {
            position: absolute;
            left: 80px;
            right: 10px;
            top: 5px;
            bottom: 5px;
            display: flex;
            gap: 0;
        }

        .data-segment {
            flex: 1;
            min-width: 2px;
            height: 100%;
            border-right: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .data-segment:hover {
            transform: scaleX(1.5) scaleY(1.2);
            z-index: 10;
        }

        .data-segment.occupied {
            background: var(--occupied-color);
        }

        .data-segment.unoccupied {
            background: var(--unoccupied-color);
        }

        .data-segment.active {
            background: var(--active-color);
        }

        .data-segment.standby {
            background: var(--standby-color);
        }

        .data-segment.missing {
            background: var(--missing-data);
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.1) 2px,
                rgba(0,0,0,0.1) 4px
            );
        }

        .violation-line {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--violation-color);
            z-index: 15;
            cursor: pointer;
        }

        .time-axis {
            position: relative;
            height: 30px;
            margin: 10px 0;
            padding-left: 80px;
            padding-right: 10px;
        }

        .time-tick {
            position: absolute;
            font-size: 10px;
            color: #666;
            transform: translateX(-50%);
        }

        .legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .window-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .window-size-selector select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ODCV Timeline - September 2025 - Sliding Window View</h1>
    </div>

    <div class="month-navigator">
        <div class="month-overview-bar">
            <div class="month-grid" id="month-grid"></div>
            <div class="viewing-window" id="viewing-window">
                <div class="window-info" id="window-info">Sept 1, 00:00 - 12:00</div>
            </div>
        </div>
        <div class="window-size-selector">
            <label>Window Size:</label>
            <select id="window-size" onchange="updateWindowSize()">
                <option value="4">4 hours</option>
                <option value="8">8 hours</option>
                <option value="12" selected>12 hours</option>
                <option value="24">24 hours</option>
            </select>
            <button class="btn" onclick="jumpToNow()">Jump to Now</button>
            <button class="btn" onclick="previousWindow()">← Previous</button>
            <button class="btn" onclick="nextWindow()">Next →</button>
        </div>
    </div>

    <div class="main-viewer">
        <div class="viewer-header">
            <div class="current-range" id="current-range">September 1, 2025 - 00:00 to 12:00</div>
            <div class="viewer-controls">
                <button class="btn" onclick="zoomIn()">Zoom In</button>
                <button class="btn" onclick="zoomOut()">Zoom Out</button>
                <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
            </div>
        </div>

        <div id="zones-container"></div>

        <div class="time-axis" id="time-axis"></div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-box" style="background: var(--occupied-color)"></div>
            <span>Occupied</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--unoccupied-color)"></div>
            <span>Unoccupied</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--active-color)"></div>
            <span>Active</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--standby-color)"></div>
            <span>Standby</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--violation-color)"></div>
            <span>Violation</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: var(--missing-data)"></div>
            <span>Missing</span>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        let currentWindowStart = 0; // Hours from month start
        let windowSizeHours = 12;
        let monthData = {};
        let isDragging = false;
        let dragStartX = 0;
        let dragStartWindow = 0;

        // Generate month data
        function generateMonthData() {
            const zones = ['BV200', 'BV201', 'BV202'];
            const hoursInMonth = 30 * 24;

            zones.forEach(zone => {
                monthData[zone] = {
                    occupancy: [],
                    control: [],
                    violations: []
                };

                for (let hour = 0; hour < hoursInMonth; hour++) {
                    const dayOfMonth = Math.floor(hour / 24) + 1;
                    const hourOfDay = hour % 24;

                    // Generate occupancy data (30-second intervals)
                    for (let i = 0; i < 120; i++) {
                        let occupied = false;

                        // Weekday pattern
                        if (dayOfMonth % 7 !== 0 && dayOfMonth % 7 !== 6) {
                            if (hourOfDay >= 8 && hourOfDay <= 18) {
                                occupied = Math.random() > 0.3;
                            } else {
                                occupied = Math.random() > 0.95;
                            }
                        } else {
                            // Weekend pattern
                            occupied = Math.random() > 0.9;
                        }

                        // Missing data simulation
                        if (Math.random() < 0.02) {
                            monthData[zone].occupancy.push(null);
                        } else {
                            monthData[zone].occupancy.push(occupied);
                        }
                    }

                    // Generate control data (1-minute intervals)
                    for (let i = 0; i < 60; i++) {
                        const lookbackIndex = hour * 120 + i * 2;
                        const recentOccupancy = monthData[zone].occupancy
                            .slice(Math.max(0, lookbackIndex - 30), lookbackIndex);

                        const hasOccupancy = recentOccupancy.some(o => o === true);
                        let control = hasOccupancy ? 'active' : 'standby';

                        // Violations
                        if (Math.random() < 0.03) {
                            control = hasOccupancy ? 'standby' : 'active';
                            monthData[zone].violations.push({
                                hour: hour,
                                minute: i,
                                type: control
                            });
                        }

                        // Missing data
                        if (Math.random() < 0.01) {
                            monthData[zone].control.push(null);
                        } else {
                            monthData[zone].control.push(control);
                        }
                    }
                }
            });
        }

        // Initialize month navigator
        function initMonthNavigator() {
            const grid = document.getElementById('month-grid');

            for (let day = 1; day <= 30; day++) {
                const dayCol = document.createElement('div');
                dayCol.className = 'day-column';
                dayCol.dataset.day = day;
                dayCol.onclick = () => jumpToDay(day);

                // Calculate activity level for this day
                const startHour = (day - 1) * 24;
                const endHour = day * 24;
                let activity = 0;
                let violations = 0;

                Object.keys(monthData).forEach(zone => {
                    const dayOccupancy = monthData[zone].occupancy.slice(
                        startHour * 120,
                        endHour * 120
                    );
                    activity += dayOccupancy.filter(o => o === true).length / dayOccupancy.length;
                    violations += monthData[zone].violations.filter(
                        v => v.hour >= startHour && v.hour < endHour
                    ).length;
                });

                dayCol.innerHTML = `
                    <div class="day-label">${day}</div>
                    ${violations > 0 ? '<div class="violation-indicator"></div>' : ''}
                    <div class="day-activity" style="height: ${activity * 100}%"></div>
                `;

                grid.appendChild(dayCol);
            }

            updateWindowPosition();
        }

        // Update window position
        function updateWindowPosition() {
            const window = document.getElementById('viewing-window');
            const windowInfo = document.getElementById('window-info');
            const monthWidth = 100; // percentage
            const hoursInMonth = 30 * 24;

            const windowWidth = (windowSizeHours / hoursInMonth) * monthWidth;
            const windowLeft = (currentWindowStart / hoursInMonth) * monthWidth;

            window.style.width = windowWidth + '%';
            window.style.left = windowLeft + '%';

            // Update window info
            const startDay = Math.floor(currentWindowStart / 24) + 1;
            const startHour = currentWindowStart % 24;
            const endHour = (currentWindowStart + windowSizeHours) % 24;
            const endDay = Math.floor((currentWindowStart + windowSizeHours) / 24) + 1;

            windowInfo.textContent = `Sept ${startDay}, ${startHour}:00 - ${endDay > 30 ? 30 : endDay}, ${endHour}:00`;
            document.getElementById('current-range').textContent =
                `September ${startDay}, 2025 - ${startHour}:00 to ${endDay > 30 ? 30 : endDay}, ${endHour}:00`;

            renderWindowData();
        }

        // Render data for current window
        function renderWindowData() {
            const container = document.getElementById('zones-container');
            container.innerHTML = '';

            Object.keys(monthData).forEach(zone => {
                const zoneDiv = document.createElement('div');
                zoneDiv.className = 'zone-container';

                const startIdx = currentWindowStart * 120; // 120 30-sec readings per hour
                const endIdx = (currentWindowStart + windowSizeHours) * 120;

                const occupancySlice = monthData[zone].occupancy.slice(startIdx, endIdx);
                const controlSlice = monthData[zone].control.slice(
                    currentWindowStart * 60,
                    (currentWindowStart + windowSizeHours) * 60
                );
                const relevantViolations = monthData[zone].violations.filter(
                    v => v.hour >= currentWindowStart && v.hour < currentWindowStart + windowSizeHours
                );

                zoneDiv.innerHTML = `
                    <div class="zone-header">${zone} - Sensor/Control Signal-Response Pair</div>
                    <div class="signal-response-viewer">
                        <div class="timeline-row">
                            <div class="row-label">Occupancy</div>
                            <div class="data-canvas">
                                ${renderDataSegments(occupancySlice, 'occupancy')}
                            </div>
                        </div>
                        <div class="timeline-row">
                            <div class="row-label">Control</div>
                            <div class="data-canvas">
                                ${renderDataSegments(controlSlice, 'control')}
                            </div>
                            ${renderViolationMarkers(relevantViolations)}
                        </div>
                    </div>
                `;

                container.appendChild(zoneDiv);
            });

            renderTimeAxis();
        }

        function renderDataSegments(data, type) {
            let html = '';
            const segmentSize = Math.ceil(data.length / (windowSizeHours * 12)); // 12 segments per hour

            for (let i = 0; i < data.length; i += segmentSize) {
                const segment = data.slice(i, i + segmentSize);
                let className = 'missing';

                if (segment.some(d => d !== null)) {
                    if (type === 'occupancy') {
                        const occupied = segment.filter(d => d === true).length;
                        className = occupied > segment.length / 2 ? 'occupied' : 'unoccupied';
                    } else {
                        const active = segment.filter(d => d === 'active').length;
                        className = active > segment.length / 2 ? 'active' : 'standby';
                    }
                }

                const timestamp = currentWindowStart + (i / data.length) * windowSizeHours;
                html += `<div class="data-segment ${className}" data-time="${timestamp}"></div>`;
            }

            return html;
        }

        function renderViolationMarkers(violations) {
            let html = '';
            violations.forEach(v => {
                const position = ((v.hour - currentWindowStart) / windowSizeHours) * 100;
                html += `<div class="violation-line" style="left: calc(80px + ${position}%)"></div>`;
            });
            return html;
        }

        function renderTimeAxis() {
            const axis = document.getElementById('time-axis');
            axis.innerHTML = '';

            const tickCount = Math.min(windowSizeHours, 12);
            for (let i = 0; i <= tickCount; i++) {
                const hour = currentWindowStart + (i / tickCount) * windowSizeHours;
                const day = Math.floor(hour / 24) + 1;
                const hourOfDay = Math.floor(hour % 24);

                const tick = document.createElement('div');
                tick.className = 'time-tick';
                tick.style.left = `calc(80px + ${(i / tickCount) * 100}%)`;
                tick.textContent = `${day}/${hourOfDay.toString().padStart(2, '0')}:00`;
                axis.appendChild(tick);
            }
        }

        // Window controls
        function updateWindowSize() {
            const select = document.getElementById('window-size');
            windowSizeHours = parseInt(select.value);
            updateWindowPosition();
        }

        function jumpToDay(day) {
            currentWindowStart = (day - 1) * 24;
            updateWindowPosition();
        }

        function jumpToNow() {
            // Simulate "now" as day 15, 14:00
            currentWindowStart = 14 * 24 + 14;
            updateWindowPosition();
        }

        function previousWindow() {
            currentWindowStart = Math.max(0, currentWindowStart - windowSizeHours);
            updateWindowPosition();
        }

        function nextWindow() {
            const maxStart = 30 * 24 - windowSizeHours;
            currentWindowStart = Math.min(maxStart, currentWindowStart + windowSizeHours);
            updateWindowPosition();
        }

        function zoomIn() {
            if (windowSizeHours > 4) {
                windowSizeHours = Math.max(4, windowSizeHours / 2);
                document.getElementById('window-size').value = windowSizeHours;
                updateWindowPosition();
            }
        }

        function zoomOut() {
            if (windowSizeHours < 24) {
                windowSizeHours = Math.min(24, windowSizeHours * 2);
                document.getElementById('window-size').value = windowSizeHours;
                updateWindowPosition();
            }
        }

        function refreshData() {
            renderWindowData();
        }

        // Drag functionality for window
        document.addEventListener('DOMContentLoaded', () => {
            const window = document.getElementById('viewing-window');

            window.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStartX = e.clientX;
                dragStartWindow = currentWindowStart;
                window.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - dragStartX;
                    const monthElement = document.querySelector('.month-overview-bar');
                    const monthWidth = monthElement.offsetWidth;
                    const hoursInMonth = 30 * 24;

                    const hoursDelta = (deltaX / monthWidth) * hoursInMonth;
                    currentWindowStart = Math.max(0,
                        Math.min(hoursInMonth - windowSizeHours,
                            dragStartWindow + hoursDelta));

                    updateWindowPosition();
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                const window = document.getElementById('viewing-window');
                window.style.cursor = 'grab';
            });

            // Tooltip
            document.addEventListener('mousemove', (e) => {
                const tooltip = document.getElementById('tooltip');
                if (e.target.classList.contains('data-segment')) {
                    const time = parseFloat(e.target.dataset.time);
                    const day = Math.floor(time / 24) + 1;
                    const hour = Math.floor(time % 24);
                    const minute = Math.floor((time % 1) * 60);

                    let status = 'Unknown';
                    if (e.target.classList.contains('occupied')) status = 'Occupied';
                    if (e.target.classList.contains('unoccupied')) status = 'Unoccupied';
                    if (e.target.classList.contains('active')) status = 'Active Mode';
                    if (e.target.classList.contains('standby')) status = 'Standby Mode';
                    if (e.target.classList.contains('missing')) status = 'Missing Data';

                    tooltip.innerHTML = `Sept ${day}, ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} - ${status}`;
                    tooltip.style.display = 'block';
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY - 30 + 'px';
                } else {
                    tooltip.style.display = 'none';
                }
            });
        });

        // Initialize
        generateMonthData();
        initMonthNavigator();
    </script>
</body>
</html>